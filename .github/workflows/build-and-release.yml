name: æž„å»ºå’Œå‘å¸ƒåˆ°ç§æœ‰ä»“åº“
on:
  push:
    tags: ['v*']

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ä»£ç æ£€æŸ¥ä»»åŠ¡
  lint:
    name: ä»£ç æ£€æŸ¥
    runs-on: ubuntu-24.04
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update && sudo apt-get install -y libfontconfig1-dev
        npm i -g yarn

    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        cd app && yarn
        cd .. && rm -f app/node_modules/.yarn-integrity
        yarn

    - name: æž„å»ºç±»åž‹å®šä¹‰
      run: yarn run build:typings

    - name: æ‰§è¡Œä»£ç æ£€æŸ¥
      run: yarn run lint

  # Windowsæž„å»ºä»»åŠ¡
  build-windows:
    name: Windowsæž„å»º (x64)
    runs-on: windows-latest
    needs: lint
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: å®‰è£…Rustç›®æ ‡
      run: rustup target add x86_64-pc-windows-msvc

    - name: æ›´æ–°node-gyp
      run: |
        npm install --global node-gyp@10.2.0
        npm prefix -g | % {npm config set node_gyp "$_\node_modules\node-gyp\bin\node-gyp.js"}

    - name: å®‰è£…ä¾èµ–å¹¶æž„å»º
      shell: powershell
      run: |
        npm i -g yarn node-gyp
        yarn --network-timeout 1000000
        yarn run build
        node scripts/prepackage-plugins.mjs
      env:
        ARCH: x64
        RUST_TARGET_TRIPLE: x86_64-pc-windows-msvc

    - name: æž„å»ºWindowsåº”ç”¨
      run: node scripts/build-windows.mjs
      env:
        ARCH: x64

    - name: æ•´ç†æž„å»ºäº§ç‰©
      run: |
        mkdir artifacts-setup
        mkdir artifacts-portable
        if (Test-Path "dist/*-setup-*.exe") { Move-Item "dist/*-setup-*.exe" "artifacts-setup/" }
        if (Test-Path "dist/*-portable-*.zip") { Move-Item "dist/*-portable-*.zip" "artifacts-portable/" }
      shell: powershell

    - name: ä¸Šä¼ Windowså®‰è£…åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer-x64
        path: artifacts-setup/*
      if: always()

    - name: ä¸Šä¼ Windowsä¾¿æºç‰ˆ
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable-x64
        path: artifacts-portable/*
      if: always()

  # macOSæž„å»ºä»»åŠ¡
  build-macos:
    name: macOSæž„å»º (arm64)
    runs-on: macos-15
    needs: lint
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: å®‰è£…Rustç›®æ ‡
      run: rustup target add aarch64-apple-darwin

    - name: å®‰è£…ä¾èµ–
      run: |
        npm i -g yarn
        yarn --network-timeout 1000000
      env:
        ARCH: arm64

    - name: æž„å»ºå‰ç«¯
      run: yarn run build

    - name: é¢„æ‰“åŒ…æ’ä»¶
      run: node scripts/prepackage-plugins.mjs
      env:
        ARCH: arm64

    - name: ä¿®å¤electron-builderé—®é¢˜
      run: |
        sed -i '' 's/updateInfo = await/\/\/updateInfo = await/g' node_modules/app-builder-lib/out/targets/ArchiveTarget.js || true
        ln -s ../../node_modules/electron app/node_modules || true

    - name: æž„å»ºmacOSåº”ç”¨
      run: node scripts/build-macos.mjs
      env:
        ARCH: arm64
        RUST_TARGET_TRIPLE: aarch64-apple-darwin
        USE_HARD_LINKS: false

    - name: æ•´ç†æž„å»ºäº§ç‰©
      run: |
        mkdir -p artifacts-dmg artifacts-zip
        echo "ðŸ“ æ£€æŸ¥ dist ç›®å½•å†…å®¹:"
        ls -la dist/ || echo "dist ç›®å½•ä¸å­˜åœ¨"
        
        # ç§»åŠ¨ dmg æ–‡ä»¶
        if ls dist/*.dmg 1> /dev/null 2>&1; then
          echo "âœ… æ‰¾åˆ° DMG æ–‡ä»¶"
          mv dist/*.dmg artifacts-dmg/
        else
          echo "âŒ æœªæ‰¾åˆ° DMG æ–‡ä»¶"
        fi
        
        # ç§»åŠ¨ zip æ–‡ä»¶
        if ls dist/*.zip 1> /dev/null 2>&1; then
          echo "âœ… æ‰¾åˆ° ZIP æ–‡ä»¶"
          mv dist/*.zip artifacts-zip/
        else
          echo "âŒ æœªæ‰¾åˆ° ZIP æ–‡ä»¶"
        fi
        
        echo "ðŸ“¦ æ•´ç†åŽçš„æž„å»ºäº§ç‰©:"
        ls -la artifacts-dmg/ artifacts-zip/

    - name: æ£€æŸ¥ DMG æ–‡ä»¶
      id: check_dmg
      run: |
        if ls artifacts-dmg/*.dmg 1> /dev/null 2>&1; then
          echo "has_dmg=true" >> $GITHUB_OUTPUT
        else
          echo "has_dmg=false" >> $GITHUB_OUTPUT
        fi

    - name: ä¸Šä¼ macOS DMG
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg-arm64
        path: artifacts-dmg/*
      if: steps.check_dmg.outputs.has_dmg == 'true'

    - name: æ£€æŸ¥ ZIP æ–‡ä»¶
      id: check_zip
      run: |
        if ls artifacts-zip/*.zip 1> /dev/null 2>&1; then
          echo "has_zip=true" >> $GITHUB_OUTPUT
        else
          echo "has_zip=false" >> $GITHUB_OUTPUT
        fi

    - name: ä¸Šä¼ macOS ZIP
      uses: actions/upload-artifact@v4
      with:
        name: macos-zip-arm64
        path: artifacts-zip/*
      if: steps.check_zip.outputs.has_zip == 'true'

  # å‘å¸ƒä»»åŠ¡
  release:
    name: åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-24.04
    needs: [build-windows, build-macos]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release
        echo "ðŸ“ æ•´ç†æž„å»ºäº§ç‰©..."
        find artifacts -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.zip" \) -exec cp {} release/ \;
        
        echo "ðŸ“¦ å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
        ls -la release/
        
        echo "ðŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
        echo "Windows x64: $(find release -name "*.exe" -o -name "*windows*.zip" | wc -l) ä¸ªæ–‡ä»¶"
        echo "macOS arm64: $(find release -name "*.dmg" -o -name "*macos*.zip" | wc -l) ä¸ªæ–‡ä»¶"

    - name: èŽ·å–å‘å¸ƒä¿¡æ¯
      id: release_info
      run: |
        echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "release_name=Tabby Terminal ${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        echo "is_prerelease=false" >> $GITHUB_OUTPUT

    - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
        # ðŸš€ Tabby Terminal å‘å¸ƒ

        åŸºäºŽåŽŸç‰ˆ [Tabby Terminal](https://github.com/Eugeny/tabby) çš„å®šåˆ¶ç‰ˆæœ¬ã€‚

        ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž

        ### Windows ç‰ˆæœ¬
        - **å®‰è£…ç‰ˆ**: `*-setup-*.exe` - æŽ¨èç”¨æˆ·ä½¿ç”¨ï¼Œä¼šè‡ªåŠ¨å®‰è£…åˆ°ç³»ç»Ÿ
        - **ä¾¿æºç‰ˆ**: `*-portable-*.zip` - ç»¿è‰²ç‰ˆæœ¬ï¼Œè§£åŽ‹å³ç”¨

        ### macOS ç‰ˆæœ¬  
        - **DMG å®‰è£…åŒ…**: `*.dmg` - æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹å®‰è£…
        - **ZIP åŽ‹ç¼©åŒ…**: `*.zip` - ç›´æŽ¥è§£åŽ‹ä½¿ç”¨

        ## ðŸ”§ æž¶æž„æ”¯æŒ

        - **Windows x64**: Intel/AMD 64ä½å¤„ç†å™¨
        - **macOS arm64**: Apple Silicon (M1/M2/M3/M4) èŠ¯ç‰‡

        ## âš™ï¸ ä¸»è¦åŠŸèƒ½

        - ðŸ–¥ï¸ å¤šå¹³å°ç»ˆç«¯æ¨¡æ‹Ÿå™¨
        - ðŸ”Œ ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ
        - ðŸŽ¨ å¯å®šåˆ¶çš„ä¸»é¢˜å’Œå¤–è§‚
        - ðŸ” SSH/Telnet/Serial è¿žæŽ¥æ”¯æŒ
        - ðŸ“‚ æ–‡ä»¶ä¼ è¾“å’Œç®¡ç†
        - ðŸ›¡ï¸ å®‰å…¨è¿žæŽ¥å’Œå¯†é’¥ç®¡ç†

        ## ðŸ”— ç›¸å…³é“¾æŽ¥

        - [åŽŸé¡¹ç›®ä»“åº“](https://github.com/Eugeny/tabby)
        - [ç§æœ‰ä»“åº“](https://github.com/dbds-team/my_tabby)
        - [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)

        ---

        **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
        **Git æäº¤**: \`${{ github.sha }}\`  
        **å·¥ä½œæµç¨‹**: ${{ github.workflow }}
        EOF

    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.release_info.outputs.tag_name }}
        name: ${{ steps.release_info.outputs.release_name }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: ${{ steps.release_info.outputs.is_prerelease }}
        files: release/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
      run: |
        echo "ðŸŽ‰ å‘å¸ƒæˆåŠŸå®Œæˆï¼"
        echo ""
        echo "ðŸ“¦ å‘å¸ƒä¿¡æ¯:"
        echo "  ç‰ˆæœ¬: ${{ steps.release_info.outputs.release_name }}"
        echo "  æ ‡ç­¾: ${{ steps.release_info.outputs.tag_name }}"
        echo "  é¢„å‘å¸ƒ: ${{ steps.release_info.outputs.is_prerelease }}"
        echo ""
        echo "ðŸ”— è®¿é—®åœ°å€:"
        echo "  https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.tag_name }}"
        echo ""
        echo "ðŸ“‹ å‘å¸ƒå†…å®¹ç»Ÿè®¡:"
        echo "  Windows x64: $(find release -name "*.exe" -o -name "*windows*.zip" | wc -l) ä¸ªæ–‡ä»¶"
        echo "  macOS arm64: $(find release -name "*.dmg" -o -name "*macos*.zip" | wc -l) ä¸ªæ–‡ä»¶"