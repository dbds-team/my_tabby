name: æž„å»ºå’Œå‘å¸ƒåˆ°ç§æœ‰ä»“åº“
on:
  push:
    tags: ['v*']

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ä»£ç æ£€æŸ¥ä»»åŠ¡
  lint:
    name: ä»£ç æ£€æŸ¥
    runs-on: ubuntu-24.04
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update && sudo apt-get install -y libfontconfig1-dev
        npm i -g yarn

    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        cd app && yarn
        cd .. && rm -f app/node_modules/.yarn-integrity
        yarn

    - name: æž„å»ºç±»åž‹å®šä¹‰
      run: yarn run build:typings

    - name: æ‰§è¡Œä»£ç æ£€æŸ¥
      run: yarn run lint

  # Windowsæž„å»ºä»»åŠ¡
  build-windows:
    name: Windowsæž„å»º (${{ matrix.arch }})
    runs-on: windows-latest
    needs: lint
    strategy:
      matrix:
        include:
          - arch: x64
            rust_triple: x86_64-pc-windows-msvc
          - arch: arm64
            rust_triple: aarch64-pc-windows-msvc
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: å®‰è£…Rustç›®æ ‡
      run: rustup target add ${{ matrix.rust_triple }}

    - name: æ›´æ–°node-gyp
      run: |
        npm install --global node-gyp@10.2.0
        npm prefix -g | % {npm config set node_gyp "$_\node_modules\node-gyp\bin\node-gyp.js"}

    - name: å®‰è£…ä¾èµ–å¹¶æž„å»º
      shell: powershell
      run: |
        npm i -g yarn node-gyp
        yarn --network-timeout 1000000
        yarn run build
        node scripts/prepackage-plugins.mjs
      env:
        ARCH: ${{ matrix.arch }}
        RUST_TARGET_TRIPLE: ${{ matrix.rust_triple }}

    - name: æž„å»ºWindowsåº”ç”¨
      run: node scripts/build-windows.mjs
      env:
        ARCH: ${{ matrix.arch }}

    - name: æ•´ç†æž„å»ºäº§ç‰©
      run: |
        mkdir artifacts-setup
        mkdir artifacts-portable
        if (Test-Path "dist/*-setup-*.exe") { Move-Item "dist/*-setup-*.exe" "artifacts-setup/" }
        if (Test-Path "dist/*-portable-*.zip") { Move-Item "dist/*-portable-*.zip" "artifacts-portable/" }
      shell: powershell

    - name: ä¸Šä¼ Windowså®‰è£…åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer-${{ matrix.arch }}
        path: artifacts-setup/*
      if: always()

    - name: ä¸Šä¼ Windowsä¾¿æºç‰ˆ
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable-${{ matrix.arch }}
        path: artifacts-portable/*
      if: always()

  # macOSæž„å»ºä»»åŠ¡
  build-macos:
    name: macOSæž„å»º (${{ matrix.arch }})
    runs-on: macos-15
    needs: lint
    strategy:
      matrix:
        include:
          - arch: x86_64
            rust_triple: x86_64-apple-darwin
          - arch: arm64
            rust_triple: aarch64-apple-darwin
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: å®‰è£…Rustç›®æ ‡
      run: rustup target add ${{ matrix.rust_triple }}

    - name: å®‰è£…ä¾èµ–
      run: |
        npm i -g yarn
        yarn --network-timeout 1000000
      env:
        ARCH: ${{ matrix.arch }}

    - name: æž„å»ºå‰ç«¯
      run: yarn run build

    - name: é¢„æ‰“åŒ…æ’ä»¶
      run: node scripts/prepackage-plugins.mjs
      env:
        ARCH: ${{ matrix.arch }}

    - name: ä¿®å¤electron-builderé—®é¢˜
      run: |
        sed -i '' 's/updateInfo = await/\/\/updateInfo = await/g' node_modules/app-builder-lib/out/targets/ArchiveTarget.js || true
        ln -s ../../node_modules/electron app/node_modules || true

    - name: æž„å»ºmacOSåº”ç”¨
      run: node scripts/build-macos.mjs
      env:
        ARCH: ${{ matrix.arch }}
        RUST_TARGET_TRIPLE: ${{ matrix.rust_triple }}
        USE_HARD_LINKS: false

    - name: æ•´ç†æž„å»ºäº§ç‰©
      run: |
        mkdir -p artifacts-dmg artifacts-zip
        [[ -f dist/*.dmg ]] && mv dist/*.dmg artifacts-dmg/ || true
        [[ -f dist/*.zip ]] && mv dist/*.zip artifacts-zip/ || true
        ls -la artifacts-dmg/ artifacts-zip/

    - name: ä¸Šä¼ macOS DMG
      uses: actions/upload-artifact@v4
      with:
        name: macos-dmg-${{ matrix.arch }}
        path: artifacts-dmg/*
      if: always()

    - name: ä¸Šä¼ macOS ZIP
      uses: actions/upload-artifact@v4
      with:
        name: macos-zip-${{ matrix.arch }}
        path: artifacts-zip/*
      if: always()

  # Linuxæž„å»ºä»»åŠ¡
  build-linux:
    name: Linuxæž„å»º (${{ matrix.arch }})
    runs-on: ubuntu-24.04
    needs: lint
    strategy:
      matrix:
        include:
          - arch: x64
            rust_triple: x86_64-unknown-linux-gnu
            build_arch: x64
          - arch: arm64
            rust_triple: aarch64-unknown-linux-gnu
            build_arch: arm64
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y libfontconfig1-dev libarchive-tools
        sudo gem install fpm
        npm i -g yarn

    - name: å®‰è£…Rustç›®æ ‡
      run: rustup target add ${{ matrix.rust_triple }}

    - name: å®‰è£…ä¾èµ–
      run: yarn --network-timeout 1000000
      env:
        ARCH: ${{ matrix.build_arch }}
        npm_config_arch: ${{ matrix.build_arch }}
        npm_config_target_arch: ${{ matrix.build_arch }}
        RUST_TARGET_TRIPLE: ${{ matrix.rust_triple }}

    - name: æž„å»ºå‰ç«¯
      run: yarn run build
      env:
        ARCH: ${{ matrix.build_arch }}

    - name: é¢„æ‰“åŒ…æ’ä»¶
      run: node scripts/prepackage-plugins.mjs
      env:
        ARCH: ${{ matrix.build_arch }}

    - name: æž„å»ºLinuxåº”ç”¨
      run: node scripts/build-linux.mjs
      env:
        ARCH: ${{ matrix.build_arch }}
        RUST_TARGET_TRIPLE: ${{ matrix.rust_triple }}
        USE_HARD_LINKS: false
        USE_SYSTEM_FPM: true

    - name: æ•´ç†æž„å»ºäº§ç‰©
      run: |
        mkdir -p artifacts
        [[ -f dist/*.AppImage ]] && mv dist/*.AppImage artifacts/ || true
        [[ -f dist/*.deb ]] && mv dist/*.deb artifacts/ || true
        [[ -f dist/*.rpm ]] && mv dist/*.rpm artifacts/ || true
        [[ -f dist/*.tar.gz ]] && mv dist/*.tar.gz artifacts/ || true
        [[ -f dist/*.pacman ]] && mv dist/*.pacman artifacts/ || true
        ls -la artifacts/

    - name: ä¸Šä¼ Linuxæž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: linux-${{ matrix.arch }}
        path: artifacts/*
      if: always()

  # å‘å¸ƒä»»åŠ¡
  release:
    name: åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-24.04
    needs: [build-windows, build-macos, build-linux]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release
        echo "ðŸ“ æ•´ç†æž„å»ºäº§ç‰©..."
        find artifacts -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.tar.gz" -o -name "*.pacman" \) -exec cp {} release/ \;
        
        echo "ðŸ“¦ å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
        ls -la release/
        
        echo "ðŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
        echo "Windows æ–‡ä»¶: $(find release -name "*.exe" -o -name "*windows*.zip" | wc -l) ä¸ª"
        echo "macOS æ–‡ä»¶: $(find release -name "*.dmg" -o -name "*macos*.zip" | wc -l) ä¸ª" 
        echo "Linux æ–‡ä»¶: $(find release -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.tar.gz" -o -name "*.pacman" | wc -l) ä¸ª"

    - name: èŽ·å–å‘å¸ƒä¿¡æ¯
      id: release_info
      run: |
        echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "release_name=Tabby Terminal ${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        echo "is_prerelease=false" >> $GITHUB_OUTPUT

    - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
        # ðŸš€ Tabby Terminal å‘å¸ƒ

        åŸºäºŽåŽŸç‰ˆ [Tabby Terminal](https://github.com/Eugeny/tabby) çš„å®šåˆ¶ç‰ˆæœ¬ã€‚

        ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž

        ### Windows ç‰ˆæœ¬
        - **å®‰è£…ç‰ˆ**: `*-setup-*.exe` - æŽ¨èç”¨æˆ·ä½¿ç”¨ï¼Œä¼šè‡ªåŠ¨å®‰è£…åˆ°ç³»ç»Ÿ
        - **ä¾¿æºç‰ˆ**: `*-portable-*.zip` - ç»¿è‰²ç‰ˆæœ¬ï¼Œè§£åŽ‹å³ç”¨

        ### macOS ç‰ˆæœ¬  
        - **DMG å®‰è£…åŒ…**: `*.dmg` - æ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹å®‰è£…
        - **ZIP åŽ‹ç¼©åŒ…**: `*.zip` - ç›´æŽ¥è§£åŽ‹ä½¿ç”¨

        ### Linux ç‰ˆæœ¬
        - **AppImage**: `*.AppImage` - é€šç”¨Linuxç‰ˆæœ¬ï¼Œä¸‹è½½åŽç›´æŽ¥è¿è¡Œ
        - **DEB åŒ…**: `*.deb` - é€‚ç”¨äºŽ Ubuntu/Debian ç³»ç»Ÿ
        - **RPM åŒ…**: `*.rpm` - é€‚ç”¨äºŽ CentOS/RHEL/Fedora ç³»ç»Ÿ
        - **TAR.GZ**: `*.tar.gz` - é€šç”¨åŽ‹ç¼©åŒ…ç‰ˆæœ¬
        - **Pacman**: `*.pacman` - é€‚ç”¨äºŽ Arch Linux ç³»ç»Ÿ

        ## ðŸ”§ æž¶æž„æ”¯æŒ

        - **x64/amd64**: Intel/AMD 64ä½å¤„ç†å™¨
        - **arm64**: Apple Silicon (M1/M2) å’Œ ARM64 å¤„ç†å™¨

        ## âš™ï¸ ä¸»è¦åŠŸèƒ½

        - ðŸ–¥ï¸ å¤šå¹³å°ç»ˆç«¯æ¨¡æ‹Ÿå™¨
        - ðŸ”Œ ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ
        - ðŸŽ¨ å¯å®šåˆ¶çš„ä¸»é¢˜å’Œå¤–è§‚
        - ðŸ” SSH/Telnet/Serial è¿žæŽ¥æ”¯æŒ
        - ðŸ“‚ æ–‡ä»¶ä¼ è¾“å’Œç®¡ç†
        - ðŸ›¡ï¸ å®‰å…¨è¿žæŽ¥å’Œå¯†é’¥ç®¡ç†

        ## ðŸ”— ç›¸å…³é“¾æŽ¥

        - [åŽŸé¡¹ç›®ä»“åº“](https://github.com/Eugeny/tabby)
        - [ç§æœ‰ä»“åº“](https://github.com/dbds-team/my_tabby)
        - [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)

        ---

        **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
        **Git æäº¤**: \`${{ github.sha }}\`  
        **å·¥ä½œæµç¨‹**: ${{ github.workflow }}
        EOF

    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.release_info.outputs.tag_name }}
        name: ${{ steps.release_info.outputs.release_name }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: ${{ steps.release_info.outputs.is_prerelease }}
        files: release/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
      run: |
        echo "ðŸŽ‰ å‘å¸ƒæˆåŠŸå®Œæˆï¼"
        echo ""
        echo "ðŸ“¦ å‘å¸ƒä¿¡æ¯:"
        echo "  ç‰ˆæœ¬: ${{ steps.release_info.outputs.release_name }}"
        echo "  æ ‡ç­¾: ${{ steps.release_info.outputs.tag_name }}"
        echo "  é¢„å‘å¸ƒ: ${{ steps.release_info.outputs.is_prerelease }}"
        echo ""
        echo "ðŸ”— è®¿é—®åœ°å€:"
        echo "  https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.tag_name }}"
        echo ""
        echo "ðŸ“‹ å‘å¸ƒå†…å®¹ç»Ÿè®¡:"
        echo "  Windows: $(find release -name "*.exe" -o -name "*windows*.zip" | wc -l) ä¸ªæ–‡ä»¶"
        echo "  macOS: $(find release -name "*.dmg" -o -name "*macos*.zip" | wc -l) ä¸ªæ–‡ä»¶"
        echo "  Linux: $(find release -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.tar.gz" -o -name "*.pacman" | wc -l) ä¸ªæ–‡ä»¶" 